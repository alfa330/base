<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Async Crawler — Control (auth required)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa; --accent-2:#7c3aed; --text:#e6eef8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    :root.light{
      --bg:#f5f7fb; --card:#ffffff; --muted:#667085; --accent:#2563eb; --accent-2:#7caed6; --text:#0b1220;
      --glass: rgba(2,6,23,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg), #071029); color:var(--text); -webkit-font-smoothing:antialiased}
    .container{max-width:1200px; margin:28px auto; padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 20px rgba(2,6,23,0.5); border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid; gap:14px}
    .cols-2{grid-template-columns: 1.25fr 0.85fr}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="password"], select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text) }
    input[type="checkbox"]{transform:scale(1.1); margin-right:6px}
    button { background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600 }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--text); font-weight:600}
    button.plain{background:transparent;border:none;color:var(--accent);padding:6px 8px;border-radius:8px}
    button.small{padding:6px 8px;font-size:13px;border-radius:8px}
    button.tertiary{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
    button.danger{background:#ef4444}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .log-area{height:180px; overflow:auto; background:rgba(0,0,0,0.06); padding:10px; border-radius:8px; font-family:monospace; font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .search{display:flex; gap:8px; align-items:center; margin-bottom:8px}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 16px;border-radius:10px;background:#111827;color:white;box-shadow:0 6px 20px rgba(2,6,23,0.5);z-index:80}

    /* Branches (visual upgrade) */
    .branches-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:8px}
    .branch-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:8px; min-height:90px}
    .branch-title{font-weight:800;font-size:15px}
    .branch-meta{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .branch-actions{display:flex;gap:8px; margin-top:auto; align-items:center}
    .branch-strong{font-weight:700; font-size:14px}
    .branch-pill{background:rgba(255,255,255,0.03); padding:6px 8px;border-radius:999px; font-size:12px}
    .branch-search-wrap{display:flex;gap:8px;align-items:center}
    .branch-count{font-size:12px;color:var(--muted)}

    /* Runs */
    .runs-list{display:flex;flex-direction:column; gap:10px; max-height:36vh; overflow:auto}
    .run-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:var(--glass); border:1px solid rgba(255,255,255,0.02)}
    .run-left{display:flex;gap:10px;align-items:center}
    .status-dot{width:10px;height:10px;border-radius:50%}
    .status-running{background:#10b981}
    .status-finished{background:#64748b}

    /* login modal */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{width:420px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    .modal h3{margin:0 0 8px 0}
    .modal .error{color:#f87171;margin-top:8px}
    .preview-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:120;max-width:90%;width:900px;max-height:86vh;overflow:auto}
    @media (max-width:980px){
      .cols-2{grid-template-columns: 1fr}
      .modal{width:92%}
      .preview-modal{width:92%}
      .branches-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
    }
  </style>
</head>
<body>
  <div class="container" id="appRoot" aria-hidden="false">
    <header>
      <div>
        <h1>Async Crawler — Control</h1>
        <div class="sub">Запускай обход, смотри состояние запуска и ветки — вход обязателен</div>
      </div>
      <div class="top-actions">
        <div class="small muted">WS: <span id="ws_status">—</span></div>
        <div id="userBlock" style="display:flex;align-items:center;gap:8px">
          <div class="mini muted" id="userName">—</div>
          <button id="btnLogin" class="ghost">Вход</button>
          <button id="btnLogout" class="ghost" style="display:none">Выйти</button>
        </div>
        <button id="btnRefresh" class="ghost" title="Обновить ветки">Обновить</button>
        <button id="toggleTheme" class="ghost">Тёмная/Светлая</button>
      </div>
    </header>

    <main class="grid cols-2" style="align-items:start">
      <!-- LEFT: Runs and Logs -->
      <section>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div style="font-weight:700">Start new crawl</div>
              <div class="small muted">Укажи стартовый URL и опции</div>
            </div>
            <div class="tag" id="last_run_info">—</div>
          </div>

          <div style="display:grid;gap:8px">
            <label>Start URL
              <input id="start_url" type="text" placeholder="https://example.com/path" />
            </label>

            <div style="display:flex;gap:8px">
              <label style="flex:1">Prefix (optional)
                <input id="prefix" type="text" placeholder="/docs/path" />
              </label>
              <label style="width:120px">Concurrency
                <input id="concurrency" type="number" value="5" min="1" />
              </label>
            </div>

            <div class="row">
              <label><input id="save_html" type="checkbox" /> Save raw HTML</label>
              <label class="small muted" style="margin-left:auto">Max preview: <span id="max_preview">200</span> chars</label>
            </div>

            <div class="controls" style="margin-top:6px">
              <button id="btnStart" disabled>Start</button>
              <button id="btnStartBG" class="ghost" title="Start in background" disabled>Start (bg)</button>
              <button id="btnStopAll" class="ghost" disabled>Stop all</button>
            </div>

            <pre id="start_result" class="log-area" style="margin-top:10px"></pre>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Active runs</div>
            <div class="small muted">Текущие запуски</div>
          </div>
          <div class="runs-list" id="runs"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Event log</div>
            <div class="small muted">Последние события</div>
          </div>
          <div id="log" class="log-area"></div>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="btnClearLog" class="ghost">Очистить</button>
            <button id="btnDownloadLog" class="ghost" disabled>Скачать лог (последний)</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: Branches -->
      <aside>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div style="font-weight:700">Branches (ветки)</div>
              <div class="small muted">Группировка файлов — удобно скачивать и фильтровать</div>
            </div>
            <div class="branch-search-wrap">
              <input id="branch_q" type="text" placeholder="Поиск веток..." />
              <select id="branch_sort" class="ghost" style="padding:8px;border-radius:8px">
                <option value="files_desc">По файлам ↓</option>
                <option value="files_asc">По файлам ↑</option>
                <option value="name_az">По имени A→Z</option>
                <option value="name_za">По имени Z→A</option>
              </select>
            </div>
          </div>

          <div id="dirs" class="branches-grid" aria-live="polite">
            <div class="small muted">Загрузка веток...</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
            <button id="btnRefreshDirs" class="ghost">Обновить ветки</button>
            <button id="btnDownloadSelected" class="ghost" disabled>Download selected</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      Crawler UI — оптимизированный интерфейс. Убраны прямые потоки Outputs, оставлены ветки (Branches) и логи.
    </footer>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Login modal (shown automatically, required) -->
  <div id="loginModalWrap" style="display:none">
    <div class="modal-backdrop" id="loginBackdrop" aria-hidden="false">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <h3 id="loginTitle">Вход (обязательно)</h3>
        <div class="mini muted">Войдите, чтобы управлять краулером. Без входа интерфейс недоступен.</div>
        <div style="margin-top:12px">
          <label>Логин
            <input id="loginInput" type="text" autocomplete="username" />
          </label>
          <label style="margin-top:10px">Пароль
            <input id="passwordInput" type="password" autocomplete="current-password" />
          </label>
          <div class="error" id="loginError" style="display:none"></div>
          <div class="row" style="margin-top:12px; justify-content:flex-end">
            <button id="loginCancel" class="ghost">Отмена</button>
            <button id="loginSubmit">Войти</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API = '/api'; // local crawler backend
const API_BASE_URL = 'https://otp-2-fos4.onrender.com'; // external auth
const WS_PATH = '/ws';
const MAX_LOG_CHARS = 12000;

/* ========== STATE ========== */
let ws = null;
let reconnectTimer = null;
let pingInterval = null;
let activeRuns = {}; // run_id -> meta
let theme = localStorage.getItem('theme') || 'dark';
if(theme === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
document.getElementById('max_preview').innerText = 200;

let user = null; // {role,id,name,telegram_id,apiKey}
let dirs = []; // branches list
let selectedBranch = null;

/* ========== USER STORAGE & UI ========== */
function loadUser(){
  try{
    const raw = localStorage.getItem('crawler_user');
    if(raw) user = JSON.parse(raw);
  }catch(e){ user = null; }
  updateUserUI();
}
function saveUser(u){
  user = u;
  if(u) {
    const safe = { role: u.role || null, id: u.id || null, name: u.name || null, telegram_id: u.telegram_id || null, apiKey: u.apiKey || null };
    localStorage.setItem('crawler_user', JSON.stringify(safe));
  } else {
    localStorage.removeItem('crawler_user');
  }
  updateUserUI();
}
function updateUserUI(){
  const userName = document.getElementById('userName');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const startBtn = document.getElementById('btnStart');
  const startBG = document.getElementById('btnStartBG');
  const refreshBtn = document.getElementById('btnRefresh');
  const stopAllBtn = document.getElementById('btnStopAll');
  const downloadLogBtn = document.getElementById('btnDownloadLog');
  const downloadSelected = document.getElementById('btnDownloadSelected');

  if(user && user.name){
    userName.innerText = user.name + (user.role ? ` (${user.role})` : '');
    if(btnLogin) btnLogin.style.display = 'none';
    if(btnLogout) btnLogout.style.display = 'inline-flex';
    if(startBtn) startBtn.disabled = false;
    if(startBG) startBG.disabled = false;
    if(refreshBtn) refreshBtn.disabled = false;
    if(stopAllBtn) stopAllBtn.disabled = false;
    if(downloadLogBtn) downloadLogBtn.disabled = false;
    if(downloadSelected) downloadSelected.disabled = !selectedBranch;
  } else {
    if(userName) userName.innerText = '—';
    if(btnLogin) btnLogin.style.display = 'inline-flex';
    if(btnLogout) btnLogout.style.display = 'none';
    if(startBtn) startBtn.disabled = true;
    if(startBG) startBG.disabled = true;
    if(refreshBtn) refreshBtn.disabled = true;
    if(stopAllBtn) stopAllBtn.disabled = true;
    if(downloadLogBtn) downloadLogBtn.disabled = true;
    if(downloadSelected) downloadSelected.disabled = true;
  }
}

/* ========== HELPERS ========== */
function toast(text, ms=3000){
  const t = document.getElementById('toast');
  t.innerText = text;
  t.style.display = 'block';
  clearTimeout(t._h);
  t._h = setTimeout(()=> t.style.display='none', ms);
}
function logEvent(obj){
  const el = document.getElementById('log');
  const ts = (new Date()).toLocaleTimeString();
  const line = `${ts} — ${JSON.stringify(obj)}\n`;
  el.innerText = line + el.innerText;
  if(el.innerText.length > MAX_LOG_CHARS){
    el.innerText = el.innerText.slice(0, MAX_LOG_CHARS);
  }
}
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"'`]/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[m]));
}
function encodeName(n){ return encodeURIComponent(n); }

function defaultHeaders(){
  const headers = { 'Accept': 'application/json' };
  if(user && user.apiKey){
    headers['x-api-key'] = user.apiKey;
  }
  return headers;
}

/* ========== WS (only after login) ========== */
let wsTrafficBytes = 0;
function initWS(){
  if(!user || !user.apiKey){
    console.warn('WS init attempted without user apiKey');
    return;
  }
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const uri = `${proto}//${location.host}${WS_PATH}?key=${encodeURIComponent(user.apiKey)}`;
  try {
    ws = new WebSocket(uri);
  } catch(e){
    console.warn('WS create failed', e);
    updateWsStatus('error');
    return;
  }
  updateWsStatus('connecting');
  ws.onopen = () => { updateWsStatus('connected'); toast('WS connected', 1200); startPing(); startTrafficMonitor(); };
  ws.onmessage = (ev) => {
    try {
      if(typeof ev.data === 'string') wsTrafficBytes += ev.data.length;
      else if(ev.data instanceof ArrayBuffer) wsTrafficBytes += ev.data.byteLength;
    } catch(e){}
    let msg = null;
    try { msg = JSON.parse(ev.data); } catch(e){ logEvent({raw: ev.data}); return; }
    handleWsMessage(msg);
  };
  ws.onclose = () => { updateWsStatus('disconnected'); toast('WS disconnected — reconnecting', 1000); stopTrafficMonitor(); scheduleReconnect(); };
  ws.onerror = (e) => { updateWsStatus('error'); console.warn('ws error', e); stopTrafficMonitor(); };
}
function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer = setTimeout(()=>{ reconnectTimer=null; if(user && user.apiKey) initWS(); }, 3000); }
function updateWsStatus(s){ const el = document.getElementById('ws_status'); if(el) el.innerText = s; }
function startPing(){ if(pingInterval) clearInterval(pingInterval); pingInterval = setInterval(()=>{ try{ ws && ws.send('ping'); }catch(e){} }, 20000); }
function stopWS(){ try{ if(pingInterval) clearInterval(pingInterval); pingInterval=null; if(ws){ ws.close(); ws=null; } updateWsStatus('stopped'); stopTrafficMonitor(); }catch(e){} }

let trafficInterval = null;
function startTrafficMonitor(){
  if(trafficInterval) return;
  trafficInterval = setInterval(()=> {
    // console.log('WS bytes/sec:', wsTrafficBytes);
    wsTrafficBytes = 0;
  }, 1000);
}
function stopTrafficMonitor(){
  if(trafficInterval) clearInterval(trafficInterval);
  trafficInterval = null;
  wsTrafficBytes = 0;
}

/* ========== WS message handling ========== */
function handleWsMessage(msg){
  const type = msg.type || msg.event || 'event';
  if(type === 'run_started' || type === 'started'){
    activeRuns[msg.run_id] = { start_url: msg.start_url || msg.start_url, ts: Date.now() };
    renderRuns();
    logEvent({event:'run_started', run: msg.run_id});
  } else if(type === 'stopping'){
    logEvent({event:'stopping', run: msg.run_id});
  } else if(type === 'finished'){
    logEvent({event:'finished', run: msg.run_id});
    if(activeRuns[msg.run_id]) activeRuns[msg.run_id].finished = true;
    renderRuns();
  } else if(type === 'stopped_all'){
    logEvent({event:'stopped_all', runs: msg.runs || []});
    activeRuns = {};
    renderRuns();
  } else {
    // ignore saved file payloads (we removed Outputs to reduce client load)
    logEvent(msg);
  }
}

/* ========== Branches UI ========== */
async function loadDirs(){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  try{
    const res = await fetch(`${API}/dirs`, { headers: defaultHeaders() });
    if(!res.ok) throw new Error('dirs failed');
    const data = await res.json();
    dirs = data.dirs || [];
    renderDirs();
  }catch(e){
    console.warn('loadDirs', e);
    const el = document.getElementById('dirs');
    if(el) el.innerHTML = '<div class="small muted">Ошибка загрузки веток</div>';
  }
}

function renderDirs(){
  const el = document.getElementById('dirs');
  if(!el) return;
  el.innerHTML = '';
  if(!dirs || dirs.length === 0){
    el.innerHTML = '<div class="small muted">Нет веток</div>';
    return;
  }

  // apply search & sort
  const q = (document.getElementById('branch_q')?.value || '').trim().toLowerCase();
  const sort = document.getElementById('branch_sort')?.value || 'files_desc';
  let list = dirs.slice();
  if(q){
    list = list.filter(d => (d.branch && d.branch.toLowerCase().includes(q)));
  }
  if(sort === 'files_desc') list.sort((a,b)=> (b.files||0) - (a.files||0));
  else if(sort === 'files_asc') list.sort((a,b)=> (a.files||0) - (b.files||0));
  else if(sort === 'name_az') list.sort((a,b)=> (''+a.branch).localeCompare(b.branch));
  else if(sort === 'name_za') list.sort((a,b)=> (''+b.branch).localeCompare(a.branch));

  const frag = document.createDocumentFragment();
  for(const d of list){
    const card = document.createElement('div'); card.className = 'branch-card';
    const title = document.createElement('div'); title.className = 'branch-title'; title.innerText = d.branch || '—';
    const meta = document.createElement('div'); meta.className = 'branch-meta';
    const filesPill = document.createElement('span'); filesPill.className = 'branch-pill'; filesPill.innerText = `${d.files || 0} files`;
    const sizePill = document.createElement('span'); sizePill.className = 'branch-pill'; sizePill.innerText = `${Math.round((d.size||0)/1024)} KB`;
    const info = document.createElement('div'); info.className = 'branch-meta'; info.appendChild(filesPill); info.appendChild(sizePill);

    const actions = document.createElement('div'); actions.className = 'branch-actions';
    const btnSelect = document.createElement('button'); btnSelect.className = 'ghost small'; btnSelect.innerText = 'Select';
    btnSelect.onclick = ()=> { selectBranch(d.branch); };
    const btnDownload = document.createElement('button'); btnDownload.className = 'ghost small'; btnDownload.innerText = 'Download zip';
    btnDownload.onclick = ()=> { window.open(`${API}/download_dir/${encodeName(d.branch)}`, '_blank'); };
    const btnPreview = document.createElement('button'); btnPreview.className = 'plain small'; btnPreview.innerText = 'Open in explorer';
    btnPreview.onclick = ()=> { window.open(`${API}/dirs?branch=${encodeName(d.branch)}`, '_blank'); };

    actions.appendChild(btnSelect); actions.appendChild(btnDownload); actions.appendChild(btnPreview);

    card.appendChild(title);
    card.appendChild(info);
    // optional description line
    const desc = document.createElement('div'); desc.className='branch-count'; desc.innerText = d.branch || '';
    card.appendChild(desc);
    card.appendChild(actions);
    frag.appendChild(card);
  }
  el.appendChild(frag);
}

function selectBranch(branch){
  selectedBranch = branch;
  const btn = document.getElementById('btnDownloadSelected');
  if(btn) {
    btn.disabled = false;
    btn.onclick = ()=> { window.open(`${API}/download_dir/${encodeName(branch)}`, '_blank'); };
  }
  toast('Selected: ' + branch, 1500);
}

/* ========== Runs UI ========== */
function renderRuns(){
  const el = document.getElementById('runs');
  if(!el) return;
  el.innerHTML = '';
  const keys = Object.keys(activeRuns).reverse();
  if(keys.length === 0) el.innerHTML = '<div class="small muted">Нет активных запусков</div>';
  const frag = document.createDocumentFragment();
  keys.forEach(id=>{
    const r = activeRuns[id];
    const div = document.createElement('div'); div.className='run-item';
    const left = document.createElement('div'); left.className='run-left';
    const dot = document.createElement('div'); dot.className='status-dot ' + (r.finished ? 'status-finished' : 'status-running');
    const info = document.createElement('div');
    info.innerHTML = `<div class="branch-strong">${escapeHtml(id)}</div><div class="small muted">${escapeHtml(r.start_url||'')}</div>`;
    left.appendChild(dot); left.appendChild(info);
    const right = document.createElement('div');
    const btnStop = document.createElement('button'); btnStop.className='ghost small'; btnStop.innerText='Stop';
    btnStop.onclick = ()=> stopRun(id);
    const btnLogs = document.createElement('button'); btnLogs.className='ghost small'; btnLogs.innerText='Logs';
    btnLogs.onclick = ()=> downloadRunLog(id);
    right.appendChild(btnLogs); right.appendChild(btnStop);
    div.appendChild(left); div.appendChild(right);
    frag.appendChild(div);
  });
  el.appendChild(frag);
}

/* ========== API actions ========== */
async function startCrawl(bg=false){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  const start_url = document.getElementById('start_url').value.trim();
  if(!start_url) return alert('Укажи start_url');
  const prefix = document.getElementById('prefix').value || null;
  const concurrency = parseInt(document.getElementById('concurrency').value||'5',10);
  const save_html = document.getElementById('save_html').checked;
  const body = { start_url, prefix, concurrency, save_html, bg };
  try{
    const res = await fetch(`${API}/start`, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, defaultHeaders()), body: JSON.stringify(body) });
    if(!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || 'start failed');
    }
    const data = await res.json();
    document.getElementById('start_result').innerText = JSON.stringify(data, null, 2);
    if(data.run_id){
      activeRuns[data.run_id] = { start_url, ts: Date.now() };
      renderRuns();
      toast('Run started: ' + data.run_id);
      document.getElementById('last_run_info').innerText = data.run_id;
    }
  }catch(e){ console.error(e); toast('Start failed'); }
}

async function stopRun(run_id){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  if(!confirm('Остановить run ' + run_id + '?')) return;
  try{
    const res = await fetch(`${API}/stop/${encodeURIComponent(run_id)}`, { method:'POST', headers: defaultHeaders() });
    if(res.ok){
      toast('Stopping ' + run_id);
      delete activeRuns[run_id];
      renderRuns();
    } else {
      toast('Stop failed');
    }
  } catch(e){ toast('Stop error'); }
}

async function stopAll(){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  if(!confirm('Stop all runs?')) return;
  try {
    const res = await fetch(`${API}/stop_all`, { method: 'POST', headers: defaultHeaders() });
    if(res.ok){
      toast('Stopped all runs');
      activeRuns = {};
      renderRuns();
    } else {
      toast('Stop all failed');
    }
  } catch(e){
    console.error('stopAll', e);
    toast('Stop all error');
  }
}

function downloadRunLog(run_id){
  const url = `${API}/logs/${encodeName(run_id)}`;
  window.open(url, '_blank');
}

/* ========== Login logic ========== */
function showLoginModal(open = true){
  const wrap = document.getElementById('loginModalWrap');
  if(!wrap) return;
  wrap.style.display = open ? 'block' : 'none';
  if(open){
    document.getElementById('loginInput').focus();
    document.getElementById('appRoot').setAttribute('aria-hidden', 'true');
  } else {
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginInput').value = '';
    document.getElementById('passwordInput').value = '';
    document.getElementById('appRoot').setAttribute('aria-hidden', 'false');
  }
}

async function handleLogin(){
  const login = document.getElementById('loginInput').value || '';
  const password = document.getElementById('passwordInput').value || '';
  const errEl = document.getElementById('loginError');
  if(!login.trim() || !password.trim()){
    errEl.innerText = 'Пожалуйста, введите логин и пароль';
    errEl.style.display = 'block';
    setTimeout(()=> { errEl.style.display = 'none'; }, 5000);
    return;
  }
  const submitBtn = document.getElementById('loginSubmit');
  submitBtn.disabled = true;
  submitBtn.innerText = 'Вхожу...';
  try {
    const response = await fetch(`${API_BASE_URL}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login: login.trim(), password: password.trim() })
    });
    if(!response.ok){
      const text = await response.text().catch(()=>null);
      throw { network: true, status: response.status, text };
    }
    const data = await response.json();
    if (data.status === 'success') {
      const newUser = {
        role: data.role || null,
        id: data.id || null,
        name: data.name || login.trim(),
        telegram_id: data.telegram_id || null,
        apiKey: data.apiKey || data.api_key || null
      };
      if(!newUser.apiKey){
        throw new Error('API key not returned by auth server');
      }
      saveUser(newUser);
      showLoginModal(false);
      toast('Logged in successfully', 2500);
      // after login, init WS and load dirs
      initWS();
      await loadDirs();
    } else {
      errEl.innerText = 'Неправильный логин или пароль';
      errEl.style.display = 'block';
      setTimeout(()=> { errEl.style.display = 'none'; }, 5000);
    }
  } catch (err) {
    console.error('Login error:', err);
    const errElText = (err && err.text) ? (err.text || 'Ошибка сети') : (err?.message || 'Ошибка сети');
    document.getElementById('loginError').innerText = errElText;
    document.getElementById('loginError').style.display = 'block';
    setTimeout(()=> { document.getElementById('loginError').style.display = 'none'; }, 5000);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Войти';
  }
}

function handleLogout(){
  if(!confirm('Выйти?')) return;
  stopWS();
  saveUser(null);
  activeRuns = {};
  renderRuns();
  dirs = [];
  renderDirs();
  toast('Logged out', 1500);
  setTimeout(()=> showLoginModal(true), 200);
}

/* ========== UI wiring ========== */
document.getElementById('btnStart').onclick = ()=> startCrawl(false);
document.getElementById('btnStartBG').onclick = ()=> startCrawl(true);
document.getElementById('btnRefresh').onclick = ()=> { if(!user){ showLoginModal(true); toast('Вход обязателен'); return; } loadDirs(); toast('Refreshed'); };
document.getElementById('btnClearLog').onclick = ()=> { document.getElementById('log').innerText=''; };
document.getElementById('btnDownloadLog').onclick = async ()=> {
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  try{
    // ask backend for logs list (best-effort)
    const res = await fetch(`${API}/list`, { headers: defaultHeaders() });
    const data = await res.json();
    const logs = (data.files||[]).filter(f=>f.name && f.name.endsWith('.log'));
    if(logs.length===0){ toast('No logs'); return; }
    const latest = logs[logs.length-1].name.replace('.log','');
    downloadRunLog(latest);
  }catch(e){ toast('err'); }
};
document.getElementById('btnStopAll').onclick = ()=> { if(!user){ showLoginModal(true); toast('Вход обязателен'); return; } stopAll(); };
document.getElementById('toggleTheme').onclick = ()=> {
  if(document.documentElement.classList.contains('light')){ document.documentElement.classList.remove('light'); localStorage.setItem('theme','dark'); } else { document.documentElement.classList.add('light'); localStorage.setItem('theme','light'); }
};
document.getElementById('btnRefreshDirs').onclick = ()=> loadDirs();
document.getElementById('btnDownloadSelected').onclick = ()=> { if(selectedBranch) window.open(`${API}/download_dir/${encodeName(selectedBranch)}`, '_blank'); };

document.getElementById('btnLogin').onclick = ()=> showLoginModal(true);
document.getElementById('loginCancel').onclick = ()=> showLoginModal(false);
document.getElementById('loginSubmit').onclick = ()=> handleLogin();
document.getElementById('btnLogout').onclick = ()=> handleLogout();

document.getElementById('branch_q').oninput = debounce(()=> renderDirs(), 200);
document.getElementById('branch_sort').onchange = ()=> renderDirs();

/* close modal on backdrop click */
document.getElementById('loginBackdrop').onclick = (e)=> {
  if(e.target === document.getElementById('loginBackdrop')) {
    if(user) showLoginModal(false);
  }
};

/* ========== Utilities ========== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ========== Init: require login on load ========== */
loadUser();
if(user && user.apiKey){
  initWS();
  loadDirs();
} else {
  showLoginModal(true);
  updateUserUI();
}
</script>

</body>
</html>
