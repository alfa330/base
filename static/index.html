<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Async Crawler ‚Äî Control (logs & directories)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa; --accent-2:#7c3aed; --text:#e6eef8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    :root.light{
      --bg:#f5f7fb; --card:#ffffff; --muted:#667085; --accent:#2563eb; --accent-2:#7c3aed; --text:#0b1220;
      --glass: rgba(2,6,23,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,var(--bg), #071029); color:var(--text); -webkit-font-smoothing:antialiased}
    .container{max-width:1100px; margin:28px auto; padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 20px rgba(2,6,23,0.5); border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid; gap:14px}
    .cols-3{grid-template-columns: 1.3fr 1fr 0.9fr}
    label{font-size:13px;color:var(--muted)}
    input, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text) }
    button { background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600 }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--text); font-weight:600}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .runs-list{display:flex;flex-direction:column; gap:8px; max-height:40vh; overflow:auto}
    .run-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--glass)}
    .log-area{height:320px; overflow:auto; background:rgba(0,0,0,0.06); padding:10px; border-radius:8px; font-family:monospace; font-size:12px; color:var(--muted)}
    .branches{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto;margin-top:8px}
    .branch-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
    .branch-name{font-weight:700}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 16px;border-radius:10px;background:#111827;color:white;box-shadow:0 6px 20px rgba(2,6,23,0.5);z-index:80}
    .btn-danger{background:#ef4444}
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{width:360px;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    @media (max-width:980px){ .cols-3{grid-template-columns: 1fr} .modal{width:92%} }
  </style>
</head>
<body>
  <div class="container" id="appRoot">
    <header>
      <div>
        <h1>Async Crawler ‚Äî Control</h1>
        <div class="sub">–¢–µ–ø–µ—Ä—å: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –§–∞–π–ª—ã ‚Äî –ø–æ –∑–∞–ø—Ä–æ—Å—É.</div>
      </div>
      <div class="top-actions">
        <div class="small muted">WS: <span id="ws_status">‚Äî</span></div>
        <div id="userBlock" style="display:flex;align-items:center;gap:8px">
          <div class="small muted" id="userName">‚Äî</div>
          <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
          <button id="btnLogout" class="ghost" style="display:none">–í—ã–π—Ç–∏</button>
        </div>
        <button id="btnRefresh" class="ghost">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </header>

```
<main class="grid cols-3" style="align-items:start">
  <!-- Left: Start form -->
  <section>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-weight:700">Start new crawl</div>
          <div class="small muted">–ó–∞–ø—É—Å–∫ –∫—Ä–∞—É–ª–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</div>
        </div>
        <div class="small muted" id="last_run_info">‚Äî</div>
      </div>

      <label>Start URL
        <input id="start_url" type="text" placeholder="https://example.com/path" />
      </label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <label style="flex:1">Prefix (optional)
          <input id="prefix" type="text" placeholder="/docs/path" />
        </label>
        <label style="width:120px">Concurrency
          <input id="concurrency" type="number" value="5" min="1" />
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input id="save_html" type="checkbox" /> Save raw HTML</label>
        <div style="margin-left:auto"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnStart" disabled>Start</button>
        <button id="btnStopAll" class="btn-danger" disabled>Stop all runs</button>
        <button id="btnRefreshDirs" class="ghost">Refresh branches</button>
      </div>
      <pre id="start_result" class="log-area" style="margin-top:10px;height:120px"></pre>
    </div>
  </section>

  <!-- Middle: Runs + Branches -->
  <aside>
    <div class="card" style="margin-bottom:12px">
      <div style="font-weight:700;margin-bottom:8px">Active runs</div>
      <div class="runs-list" id="runs"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Branches (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)</div>
      <div class="small muted">–ù–∞–∂–º–∏ Download —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ZIP —Å —Ñ–∞–π–ª–∞–º–∏ –≤–µ—Ç–∫–∏</div>
      <div id="branches" class="branches"></div>
    </div>
  </aside>

  <!-- Right: Logs -->
  <section>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Event log</div>
        <div class="small muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
      </div>
      <div id="log" class="log-area"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnClearLog" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="btnDownloadLog" class="ghost" disabled>–°–∫–∞—á–∞—Ç—å –ª–æ–≥ (–ø–æ—Å–ª–µ–¥–Ω–∏–π)</button>
      </div>
    </div>
  </section>
</main>

<footer>Crawler UI ‚Äî —Ç–µ–ø–µ—Ä—å –±–µ–∑ –ø—Ä—è–º—ã—Ö –ø–æ—Ç–æ–∫–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ (—É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞).</footer>
```

  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Simple login modal -->

  <div id="loginModalWrap" style="display:none">
    <div class="modal-backdrop" id="loginBackdrop">
      <div class="modal" role="dialog">
        <h3>–í—Ö–æ–¥</h3>
        <div style="margin-top:8px">
          <label>–õ–æ–≥–∏–Ω <input id="loginInput" type="text" /></label>
          <label style="margin-top:8px">–ü–∞—Ä–æ–ª—å <input id="passwordInput" type="password" /></label>
          <div id="loginError" style="color:#f87171;margin-top:8px;display:none"></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button id="loginCancel" class="ghost">–û—Ç–º–µ–Ω–∞</button>
            <button id="loginSubmit">–í–æ–π—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const API = '/api';
const AUTH_API = 'https://otp-2-fos4.onrender.com';
const WS_PATH = '/ws';
let user = null; // {apiKey, name}
let ws = null;
let pingInterval = null;
let reconnectTimer = null;
let activeRuns = {};
let branchesList = [];

/* UTIL */
function toast(msg, ms=2500){ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none', ms); }
function logEvent(obj){ const el=document.getElementById('log'); const ts=new Date().toLocaleTimeString(); el.innerText = `${ts} ‚Äî ${JSON.stringify(obj)}\n` + el.innerText; }
function defaultHeaders(){ const h={'Accept':'application/json'}; if(user && user.apiKey) h['x-api-key']=user.apiKey; return h; }

/* AUTH */
function loadUser(){ try{ const raw=localStorage.getItem('crawler_user'); if(raw) user=JSON.parse(raw); }catch(e){ user=null; } updateUI(); }
function saveUser(u){ user=u; if(u) localStorage.setItem('crawler_user', JSON.stringify(u)); else localStorage.removeItem('crawler_user'); updateUI(); }
function updateUI(){
  document.getElementById('userName').innerText = user && user.name ? user.name : '‚Äî';
  const can = !!(user && user.apiKey);
  document.getElementById('btnStart').disabled = !can;
  document.getElementById('btnStopAll').disabled = !can;
  document.getElementById('btnRefreshDirs').disabled = !can;
  document.getElementById('btnRefresh').disabled = !can;
  document.getElementById('btnDownloadLog').disabled = !can;
  if(can){ document.getElementById('btnLogin').style.display='none'; document.getElementById('btnLogout').style.display='inline-flex'; } else { document.getElementById('btnLogin').style.display='inline-flex'; document.getElementById('btnLogout').style.display='none'; }
}

/* WS: only send/run/log events ‚Äî DO NOT process 'saved' files to avoid heavy payloads */
function initWS(){
  if(!user || !user.apiKey) return;
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const uri = `${proto}//${location.host}${WS_PATH}?key=${encodeURIComponent(user.apiKey)}`;
  ws = new WebSocket(uri);
  document.getElementById('ws_status').innerText = 'connecting';
  ws.onopen = ()=>{ document.getElementById('ws_status').innerText='connected'; toast('WS connected'); startPing(); };
  ws.onmessage = (ev)=> {
    let msg=null;
    try{ msg=JSON.parse(ev.data); }catch(e){ return; }
    // Important: ignore heavy 'saved' payloads ‚Äî show only light events/logs
    const t = msg.type || msg.event || 'event';
    if(t === 'saved'){
      // Instead of adding full file to UI, convert to a compact log entry + ensure branch is known
      logEvent({event:'file_saved', file: msg.file, branch: msg.branch, url: msg.url});
      if(msg.branch) { ensureBranchKnown(msg.branch); }
      return;
    }
    // Accept run lifecycle events and status messages
    if(t === 'started' || t === 'run_started'){
      activeRuns[msg.run_id] = { start_url: msg.start_url || '', ts: Date.now() };
      renderRuns();
      logEvent({event:'run_started', run: msg.run_id});
      return;
    }
    if(t === 'finished' || t === 'stopped_all' || t === 'stopping'){
      // broadcast as log
      logEvent(msg);
      if(t === 'stopped_all' && msg.runs){ msg.runs.forEach(r=> delete activeRuns[r]); renderRuns(); }
      return;
    }
    // generic fallback: append to logs
    logEvent(msg);
  };
  ws.onclose = ()=>{ document.getElementById('ws_status').innerText='disconnected'; toast('WS closed ‚Äî reconnecting'); scheduleReconnect(); };
  ws.onerror = (e)=>{ document.getElementById('ws_status').innerText='error'; console.warn('ws err', e); };
}
function startPing(){ if(pingInterval) clearInterval(pingInterval); pingInterval=setInterval(()=>{ try{ ws && ws.send('ping'); }catch(e){} },20000); }
function stopWS(){ try{ if(pingInterval) clearInterval(pingInterval); pingInterval=null; if(ws){ ws.close(); ws=null; } document.getElementById('ws_status').innerText='stopped'; }catch(e){} }
function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer=setTimeout(()=>{ reconnectTimer=null; if(user && user.apiKey) initWS(); },3000); }

/* RUNS UI */
function renderRuns(){
  const el=document.getElementById('runs'); el.innerHTML='';
  const keys=Object.keys(activeRuns).reverse();
  if(keys.length===0){ el.innerHTML='<div class="small muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤</div>'; return; }
  keys.forEach(id=>{
    const r=activeRuns[id]||{};
    const div=document.createElement('div'); div.className='run-item';
    const left=document.createElement('div'); left.innerHTML=`<div style="font-weight:700">${id}</div><div class="small muted">${escapeHtml(r.start_url||'')}</div>`;
    const right=document.createElement('div');
    const btnStop=document.createElement('button'); btnStop.innerText='Stop'; btnStop.onclick=()=> stopRun(id);
    const btnLogs=document.createElement('button'); btnLogs.className='ghost'; btnLogs.innerText='Logs'; btnLogs.onclick=()=> downloadRunLog(id);
    right.appendChild(btnLogs); right.appendChild(btnStop);
    div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}

/* BRANCHES */
function renderBranches(){
  const el=document.getElementById('branches'); el.innerHTML='';
  if(branchesList.length===0){ el.innerHTML='<div class="small muted">–ù–µ—Ç –≤–µ—Ç–æ–∫ (–¥–µ—Ä–µ–∫—Ç–æ—Ä–∏–π)</div>'; return; }
  branchesList.forEach(b=>{
    const div=document.createElement('div'); div.className='branch-item';
    const left=document.createElement('div'); left.innerHTML=`<div class="branch-name">${escapeHtml(b.branch)}</div><div class="small muted">${b.files} files ‚Ä¢ ${Math.round(b.size/1024)} KB</div>`;
    const right=document.createElement('div');
    const btnDownload=document.createElement('button'); btnDownload.className='ghost'; btnDownload.innerText='Download'; btnDownload.onclick=()=> { window.open(`${API}/download_dir/${encodeURIComponent(b.branch)}`, '_blank'); };
    const btnShowFiles=document.createElement('button'); btnShowFiles.className='ghost'; btnShowFiles.innerText='Show files'; btnShowFiles.onclick=()=> showFilesInBranch(b.branch);
    right.appendChild(btnShowFiles); right.appendChild(btnDownload);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
  // fill branch filter select
  const sel=document.getElementById('branch_filter');
  if(sel){
    sel.innerHTML = '<option value="">üóÇ –í—Å–µ –≤–µ—Ç–∫–∏</option>';
    branchesList.forEach(b=> sel.appendChild(new Option(b.branch, b.branch)));
  }
}

function ensureBranchKnown(branch){
  if(!branch) return;
  if(branchesList.find(x=>x.branch === branch)) return;
  // if unknown, refresh branch list from server (cheap)
  fetchBranches();
}

/* API ACTIONS */
async function fetchBranches(){
  if(!user){ toast('–í—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
  try{
    const res = await fetch(`${API}/dirs`, { headers: defaultHeaders() });
    if(!res.ok) throw new Error('dirs failed');
    const data = await res.json();
    branchesList = data.dirs || [];
    renderBranches();
  }catch(e){ console.warn(e); toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ç–∫–∏'); }
}

async function showFilesInBranch(branch){
  if(!user){ toast('–í—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
  try{
    const res = await fetch(`${API}/dir/${encodeURIComponent(branch)}/files`, { headers: defaultHeaders() });
    if(!res.ok) throw new Error('failed');
    const data = await res.json();
    // show lightweight file list in a modal (no heavy content transfer)
    const files = data.files || [];
    const list = files.map(f => `${f.name} (${Math.round(f.size/1024)} KB)`).join('\n');
    alert(`Files in ${branch}:\n\n` + (list || '(–ø—É—Å—Ç–æ)'));
  }catch(e){
    console.warn(e);
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª—ã –≤–µ—Ç–∫–∏');
  }
}

/* START/STOP */
async function startCrawl(){
  if(!user){ toast('–í—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
  const start_url = document.getElementById('start_url').value.trim();
  if(!start_url) return alert('–£–∫–∞–∂–∏ start_url');
  const prefix = document.getElementById('prefix').value || null;
  const concurrency = parseInt(document.getElementById('concurrency').value||'5',10);
  const save_html = document.getElementById('save_html').checked;
  const body = { start_url, prefix, concurrency, save_html };
  try{
    const res = await fetch(`${API}/start`, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, defaultHeaders()), body: JSON.stringify(body) });
    if(!res.ok) throw new Error('start failed');
    const data = await res.json();
    document.getElementById('start_result').innerText = JSON.stringify(data, null, 2);
    if(data.run_id){
      activeRuns[data.run_id] = { start_url, ts: Date.now() };
      renderRuns();
      toast('Run started: ' + data.run_id);
      document.getElementById('last_run_info').innerText = data.run_id;
    }
  }catch(e){ console.error(e); toast('Start failed'); }
}

async function stopRun(run_id){
  if(!user){ toast('–í—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
  if(!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å run ' + run_id + '?')) return;
  try{
    const res = await fetch(`${API}/stop/${encodeURIComponent(run_id)}`, { method:'POST', headers: defaultHeaders() });
    if(res.ok){ toast('Stopping ' + run_id); delete activeRuns[run_id]; renderRuns(); } else toast('Stop failed');
  }catch(e){ toast('Stop error'); }
}

async function stopAll(){
  if(!user){ toast('–í—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
  if(!confirm('Stop all runs?')) return;
  try{
    const res = await fetch(`${API}/stop_all`, { method:'POST', headers: defaultHeaders() });
    if(res.ok){ const data=await res.json(); toast('Stopped: '+ (data.stopped||[]).join(', ')); activeRuns={}; renderRuns(); } else toast('Stop all failed');
  }catch(e){ toast('Stop all error'); }
}

/* LOGS */
document.getElementById('btnClearLog').onclick = ()=> { document.getElementById('log').innerText=''; };
document.getElementById('btnRefreshDirs').onclick = ()=> fetchBranches();
document.getElementById('btnRefresh').onclick = ()=> fetchBranches();
document.getElementById('btnStart').onclick = ()=> startCrawl();
document.getElementById('btnStopAll').onclick = ()=> stopAll();

/* LOGIN handling (simple handoff to external auth) */
function showLogin(open=true){ document.getElementById('loginModalWrap').style.display = open ? 'block' : 'none'; }
document.getElementById('btnLogin').onclick = ()=> showLogin(true);
document.getElementById('loginCancel').onclick = ()=> showLogin(false);
document.getElementById('loginSubmit').onclick = async ()=> {
  const login = document.getElementById('loginInput').value.trim();
  const password = document.getElementById('passwordInput').value.trim();
  if(!login||!password){ document.getElementById('loginError').innerText='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; document.getElementById('loginError').style.display='block'; return; }
  const submit=document.getElementById('loginSubmit'); submit.disabled=true; submit.innerText='–í—Ö–æ–∂—É...';
  try{
    const resp = await fetch(`${AUTH_API}/api/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login, password })});
    if(!resp.ok) throw new Error('auth failed');
    const data = await resp.json();
    if(data.status==='success' && (data.apiKey||data.api_key)){
      const newUser = { name: data.name||login, apiKey: data.apiKey||data.api_key };
      saveUser(newUser);
      showLogin(false);
      initWS();
      fetchBranches();
      toast('Logged in');
    } else { throw new Error('auth error'); }
  }catch(e){ console.error(e); document.getElementById('loginError').innerText = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'; document.getElementById('loginError').style.display='block'; }
  finally{ submit.disabled=false; submit.innerText='–í–æ–π—Ç–∏'; }
};
document.getElementById('btnLogout').onclick = ()=> { if(!confirm('–í—ã–π—Ç–∏?')) return; stopWS(); saveUser(null); };

/* init */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"'`]/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[m])); }

function loadInit(){
  try{ const raw=localStorage.getItem('crawler_user'); if(raw) user=JSON.parse(raw); }catch(e){ user=null; }
  updateUI();
  if(user && user.apiKey){ initWS(); fetchBranches(); }
  else showLogin(true);
}
loadInit();

/* Helper functions used by UI actions */
function downloadRunLog(run_id){
  const url = `${API}/logs/${encodeURIComponent(run_id)}`;
  window.open(url, '_blank');
}
async function fetchAndShowLatestLog(){
  try{
    const res = await fetch(`${API}/list`, { headers: defaultHeaders() });
    const data = await res.json();
    const logs = (data.files || []).filter(f=>f.name.endsWith('.log'));
    if(!logs.length) return toast('No logs');
    const latest = logs[logs.length-1].name.replace('.log','');
    downloadRunLog(latest);
  }catch(e){ toast('Cannot fetch logs'); }
}
document.getElementById('btnDownloadLog').onclick = fetchAndShowLatestLog;

/* Expose some useful shortcuts for testing in console */
window.__crawler = { fetchBranches, showFilesInBranch, stopAll };

</script>

</body>
</html>
