<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Async Crawler — Control (auth required)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa; --accent-2:#7c3aed; --text:#e6eef8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    :root.light{
      --bg:#f5f7fb; --card:#ffffff; --muted:#667085; --accent:#2563eb; --accent-2:#7c3aed; --text:#0b1220;
      --glass: rgba(2,6,23,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg), #071029); color:var(--text); -webkit-font-smoothing:antialiased}
    .container{max-width:1100px; margin:28px auto; padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:0 6px 20px rgba(2,6,23,0.5); border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid; gap:14px}
    .cols-3{grid-template-columns: 1.3fr 1fr 0.9fr}
    .cols-2{grid-template-columns: 1fr 1fr}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="password"], select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text) }
    input[type="checkbox"]{transform:scale(1.1); margin-right:6px}
    button { background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600 }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--text); font-weight:600}
    button.plain{background:transparent;border:none;color:var(--accent);padding:6px 8px;border-radius:8px}
    button:disabled, .ghost[disabled]{opacity:0.45;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    #files{max-height:46vh; overflow:auto; display:flex; flex-direction:column; gap:8px; padding-top:8px}
    .file-item{display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:10px; background:var(--glass); border:1px solid rgba(255,255,255,0.02)}
    .file-meta{flex:1}
    .file-actions{display:flex;gap:8px;align-items:center}
    .fname{font-weight:700}
    .ftitle{color:var(--muted); font-size:13px; margin-top:4px}
    pre.preview{background:rgba(0,0,0,0.12); padding:8px; border-radius:8px; max-height:160px; overflow:auto; margin-top:8px; white-space:pre-wrap}
    .runs-list{display:flex;flex-direction:column; gap:8px; max-height:24vh; overflow:auto}
    .run-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--glass)}
    .log-area{height:150px; overflow:auto; background:rgba(0,0,0,0.06); padding:10px; border-radius:8px; font-family:monospace; font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .search{display:flex; gap:8px; align-items:center; margin-bottom:8px}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 16px;border-radius:10px;background:#111827;color:white;box-shadow:0 6px 20px rgba(2,6,23,0.5);z-index:80}
    .btn-danger{background:#ef4444}
    .dir-list{display:flex;flex-direction:column;gap:8px;max-height:18vh;overflow:auto;margin-top:8px}
    .dir-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .dir-meta{font-size:13px;color:var(--muted)}
    /* login modal */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{width:360px;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    .modal h3{margin:0 0 8px 0}
    .modal .error{color:#f87171;margin-top:8px}
    .modal .row{margin-top:10px}
    .mini{font-size:12px;color:var(--muted)}
    .preview-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:120;max-width:90%;width:900px;max-height:86vh;overflow:auto}
    .preview-content{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    @media (max-width:980px){
      .cols-3{grid-template-columns: 1fr}
      .modal{width:92%}
      .preview-modal{width:92%}
    }
  </style>
</head>
<body>
  <div class="container" id="appRoot" aria-hidden="false">
    <header>
      <div>
        <h1>Async Crawler — Control</h1>
        <div class="sub">Запускай обход, смотри результаты в реальном времени через WebSocket</div>
      </div>
      <div class="top-actions">
        <div class="small muted">Тек. соединение: <span id="ws_status">—</span></div>
        <div id="userBlock" style="display:flex;align-items:center;gap:8px">
          <div class="mini muted" id="userName">—</div>
          <button id="btnLogin" class="ghost">Вход</button>
          <button id="btnLogout" class="ghost" style="display:none">Выйти</button>
        </div>
        <button id="btnRefresh" class="ghost" title="Обновить список файлов">Обновить</button>
        <button id="toggleTheme" class="ghost">Тёмная/Светлая</button>
      </div>
    </header>

<main class="grid cols-3" style="align-items:start">
  <!-- Left: Start form + Outputs -->
  <section>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-weight:700">Start new crawl</div>
          <div class="small muted">Укажи стартовый URL и опции</div>
        </div>
        <div class="tag" id="last_run_info">—</div>
      </div>

      <div style="display:grid;gap:8px">
        <label>Start URL
          <input id="start_url" type="text" placeholder="https://example.com/path" />
        </label>

        <div style="display:flex;gap:8px">
          <label style="flex:1">Prefix (optional)
            <input id="prefix" type="text" placeholder="/docs/path" />
          </label>
          <label style="width:120px">Concurrency
            <input id="concurrency" type="number" value="5" min="1" />
          </label>
        </div>

        <div class="row">
          <label><input id="save_html" type="checkbox" /> Save raw HTML</label>
          <label class="small muted" style="margin-left:auto">Max preview: <span id="max_preview">20000</span> chars</label>
        </div>

        <div class="controls" style="margin-top:6px">
          <button id="btnStart" disabled>Start</button>
          <button id="btnStartBG" class="ghost" title="Start in background" disabled>Start (bg)</button>
          <button id="btnList" class="ghost" disabled>List outputs</button>
        </div>

        <pre id="start_result" class="log-area" style="margin-top:10px"></pre>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Outputs</div>
        <div class="small muted">Файлы появляются автоматически</div>
      </div>

      <div class="search">
        <input id="q" type="text" placeholder="Поиск по имени или URL" />
        <select id="sort">
          <option value="new">Сначала новые</option>
          <option value="old">Сначала старые</option>
        </select>
        <button id="clearSearch" class="ghost">Очистить</button>
      </div>

      <div id="files" aria-live="polite"></div>
    </div>
  </section>

  <!-- Middle: Runs and Logs -->
  <aside>
    <div class="card" style="margin-bottom:12px">
      <div style="font-weight:700;margin-bottom:8px">Active runs</div>
      <div class="runs-list" id="runs"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Event log</div>
        <div class="small muted">Последние события</div>
      </div>
      <div id="log" class="log-area"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnClearLog" class="ghost">Очистить</button>
        <button id="btnDownloadLog" class="ghost" disabled>Скачать лог (последний)</button>
      </div>
    </div>
  </aside>

  <!-- Right: Directories, Quick actions & help -->
  <section>
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Branches (директории)</div>
        <div class="small muted">Группировка файлов</div>
      </div>

      <div id="dirs" class="dir-list"><div class="small muted">Загрузка...</div></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnRefreshDirs" class="ghost">Обновить ветки</button>
        <button id="btnDownloadSelected" class="ghost" disabled>Download selected</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700">Quick actions</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <button id="btnShowFiles" class="ghost" disabled>Показать все файлы</button>
        <button id="btnClearOutputs" class="ghost">Очистить список (локально)</button>
        <button id="btnStopAll" class="btn-danger" disabled>Stop all runs</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700">Help</div>
      <div class="small muted" style="margin-top:8px">
        • Запуск стартует краулер на сервере. <br>
        • Каждая сохранённая страница пушится на фронт через WebSocket и отображается в Outputs. <br>
        • Файлы группируются по веткам (branch). Нажми «Download» рядом с веткой, чтобы скачать zip. <br>
        • Для управления требуется логин (API key).
      </div>
    </div>
  </section>
</main>

<footer>
  Crawler UI — оптимизированный интерфейс. Разворачивай, тестируй, улучшай.
</footer>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Login modal (shown automatically, required) -->
  <div id="loginModalWrap" style="display:none">
    <div class="modal-backdrop" id="loginBackdrop" aria-hidden="false">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <h3 id="loginTitle">Вход (обязательно)</h3>
        <div class="mini muted">Войдите, чтобы управлять краулером. Без входа интерфейс недоступен.</div>
        <div style="margin-top:12px">
          <label>Логин
            <input id="loginInput" type="text" autocomplete="username" />
          </label>
          <label style="margin-top:10px">Пароль
            <input id="passwordInput" type="password" autocomplete="current-password" />
          </label>
          <div class="error" id="loginError" style="display:none"></div>
          <div class="row" style="margin-top:12px; justify-content:flex-end">
            <button id="loginCancel" class="ghost">Отмена</button>
            <button id="loginSubmit">Войти</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview modal -->
  <div id="previewModal" class="preview-modal" style="display:none">
    <div class="preview-content card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="previewTitle" style="font-weight:700">Preview</div>
        <div>
          <button id="previewDownload" class="plain">Download</button>
          <button id="previewClose" class="ghost">Close</button>
        </div>
      </div>
      <pre id="previewBody" style="white-space:pre-wrap;max-height:70vh;overflow:auto;font-family:monospace"></pre>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API = '/api'; // local crawler backend (expects /list, /start, /stop/:id, /output/:name, /dirs, /download_dir/:branch, /logs/:id)
const API_BASE_URL = 'https://otp-2-fos4.onrender.com'; // external auth service (provided)
const WS_PATH = '/ws';
const MAX_CONTENT_LEN = 200; // when showing full content in UI, trim to this
const PREVIEW_LEN = 200; // how many chars of content kept as preview on client
const FILE_BATCH_MS = 250; // batching window for incoming WS saved events
const MAX_LOG_CHARS = 10000; // limit log size in UI

/* ========== STATE ========== */
let ws = null;
let reconnectTimer = null;
let pingInterval = null;
let activeRuns = {}; // run_id -> meta
let filesIndex = new Map(); // key: relative path (branch/file) -> {name, title, url, content_preview, branch, size, ts}
let filesOrder = [];
let theme = localStorage.getItem('theme') || 'dark';
if(theme === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
document.getElementById('max_preview').innerText = PREVIEW_LEN;

let user = null; // {role,id,name,telegram_id,apiKey}
let dirs = []; // branches list
let selectedBranch = null;

/* ========== USER STORAGE & UI ========== */
function loadUser(){
  try{
    const raw = localStorage.getItem('crawler_user');
    if(raw) user = JSON.parse(raw);
  }catch(e){ user = null; }
  updateUserUI();
}
function saveUser(u){
  user = u;
  if(u) {
    // keep only small user object — do not store large data
    const safe = { role: u.role || null, id: u.id || null, name: u.name || null, telegram_id: u.telegram_id || null, apiKey: u.apiKey || null };
    localStorage.setItem('crawler_user', JSON.stringify(safe));
  } else {
    localStorage.removeItem('crawler_user');
  }
  updateUserUI();
}
function updateUserUI(){
  const userName = document.getElementById('userName');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const startBtn = document.getElementById('btnStart');
  const startBG = document.getElementById('btnStartBG');
  const listBtn = document.getElementById('btnList');
  const refreshBtn = document.getElementById('btnRefresh');
  const showFilesBtn = document.getElementById('btnShowFiles');
  const stopAllBtn = document.getElementById('btnStopAll');
  const downloadLogBtn = document.getElementById('btnDownloadLog');

  if(user && user.name){
    userName.innerText = user.name + (user.role ? ` (${user.role})` : '');
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'inline-flex';
    // enable actions
    startBtn.disabled = false;
    startBG.disabled = false;
    listBtn.disabled = false;
    refreshBtn.disabled = false;
    showFilesBtn.disabled = false;
    stopAllBtn.disabled = false;
    downloadLogBtn.disabled = false;
    document.getElementById('btnDownloadSelected').disabled = !selectedBranch;
  } else {
    userName.innerText = '—';
    btnLogin.style.display = 'inline-flex';
    btnLogout.style.display = 'none';
    // disable actions
    startBtn.disabled = true;
    startBG.disabled = true;
    listBtn.disabled = true;
    refreshBtn.disabled = true;
    showFilesBtn.disabled = true;
    stopAllBtn.disabled = true;
    downloadLogBtn.disabled = true;
    document.getElementById('btnDownloadSelected').disabled = true;
  }
}

/* ========== HELPERS ========== */
function toast(text, ms=3000){
  const t = document.getElementById('toast');
  t.innerText = text;
  t.style.display = 'block';
  clearTimeout(t._h);
  t._h = setTimeout(()=> t.style.display='none', ms);
}
function logEvent(obj){
  const el = document.getElementById('log');
  const ts = (new Date()).toLocaleTimeString();
  const line = `${ts} — ${JSON.stringify(obj)}\n`;
  el.innerText = line + el.innerText;
  if(el.innerText.length > MAX_LOG_CHARS){
    el.innerText = el.innerText.slice(0, MAX_LOG_CHARS);
  }
}
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"'`]/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[m]));
}
function encodeName(n){ return encodeURIComponent(n); }

function defaultHeaders(){
  const headers = { 'Accept': 'application/json' };
  if(user && user.apiKey){
    headers['x-api-key'] = user.apiKey;
  }
  return headers;
}

/* ========== Batching for WS file updates ========== */
let fileUpdateBuffer = [];
let fileRenderTimer = null;

function queueFileUpdate(item){
    if(fileUpdateBuffer.length > 1000){
    // apply immediately to avoid unbounded growth
    clearTimeout(fileRenderTimer);
    fileRenderTimer = null;
    for(const it of fileUpdateBuffer) addOrUpdateFileImmediate(it);
    fileUpdateBuffer = [];
    renderFiles();
    return;
  }
  // keep only necessary pieces of item to avoid memory bloat
  const slim = {
    file: item.file,
    url: item.url || '',
    title: item.title || '',
    content: item.content ? (item.content.slice(0, PREVIEW_LEN)) : '',
    branch: item.branch || (item.file && item.file.includes('/') ? item.file.split('/').slice(0,-1).join('/') : ''),
    run_id: item.run_id || ''
  };
  fileUpdateBuffer.push(slim);
  if(fileRenderTimer) return;
  fileRenderTimer = setTimeout(()=> {
    for(const it of fileUpdateBuffer) addOrUpdateFileImmediate(it);
    fileUpdateBuffer = [];
    fileRenderTimer = null;
    // render once after applying batch
    renderFiles();
  }, FILE_BATCH_MS);
}

/* immediate add/update used by the batcher */
function addOrUpdateFileImmediate(item){
  const name = item.file;
  if(!name) return;
  const now = Date.now();
  const entry = {
    name,
    url: item.url || '',
    title: item.title || '',
    content_preview: (item.content || '').slice(0, PREVIEW_LEN),
    branch: item.branch || (name.includes('/') ? name.split('/').slice(0,-1).join('/') : ''),
    run_id: item.run_id || '',
    ts: now
  };
  filesIndex.set(name, entry);
  filesOrder = Array.from(filesIndex.keys()).sort((a,b)=> filesIndex.get(b).ts - filesIndex.get(a).ts );
}

/* ========== WS (only after login) ========== */
let wsTrafficBytes = 0;
function initWS(){
  if(!user || !user.apiKey){
    console.warn('WS init attempted without user apiKey');
    return;
  }
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const uri = `${proto}//${location.host}${WS_PATH}?key=${encodeURIComponent(user.apiKey)}`;
  ws = new WebSocket(uri);
  updateWsStatus('connecting');
  ws.onopen = () => { updateWsStatus('connected'); toast('WS connected'); startPing(); startTrafficMonitor(); };
  ws.onmessage = (ev) => {
    // measure traffic
    try {
      if(typeof ev.data === 'string') wsTrafficBytes += ev.data.length;
      else if(ev.data instanceof ArrayBuffer) wsTrafficBytes += ev.data.byteLength;
    } catch(e){}
    let msg = null;
    try { msg = JSON.parse(ev.data); } catch(e){ logEvent({raw: ev.data}); return; }
    handleWsMessage(msg);
  };
  ws.onclose = () => { updateWsStatus('disconnected'); toast('WS disconnected — reconnecting'); stopTrafficMonitor(); scheduleReconnect(); };
  ws.onerror = (e) => { updateWsStatus('error'); console.warn('ws error', e); stopTrafficMonitor(); };
}
function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer = setTimeout(()=>{ reconnectTimer=null; if(user && user.apiKey) initWS(); }, 3000); }
function updateWsStatus(s){ const el = document.getElementById('ws_status'); el.innerText = s; }
function startPing(){ if(pingInterval) clearInterval(pingInterval); pingInterval = setInterval(()=>{ try{ ws && ws.send('ping'); }catch(e){} }, 20000); }
function stopWS(){ try{ if(pingInterval) clearInterval(pingInterval); pingInterval=null; if(ws){ ws.close(); ws=null; } updateWsStatus('stopped'); stopTrafficMonitor(); }catch(e){} }

let trafficInterval = null;
function startTrafficMonitor(){
  if(trafficInterval) return;
  trafficInterval = setInterval(()=> {
    console.log('WS bytes/sec:', wsTrafficBytes);
    wsTrafficBytes = 0;
  }, 1000);
}
function stopTrafficMonitor(){
  if(trafficInterval) clearInterval(trafficInterval);
  trafficInterval = null;
  wsTrafficBytes = 0;
}

/* ========== WS message handling ========== */
function handleWsMessage(msg){
  const type = msg.type || msg.event || 'event';
  if(type === 'saved'){
    queueFileUpdate(msg);
    logEvent({event:'saved', file: msg.file, run: msg.run_id, branch: msg.branch});
  } else if(type === 'run_started' || type === 'started'){
    activeRuns[msg.run_id] = { start_url: msg.start_url || msg.start_url, ts: Date.now() };
    renderRuns();
    logEvent({event:'run_started', run: msg.run_id});
  } else if(type === 'stopping'){
    logEvent({event:'stopping', run: msg.run_id});
  } else if(type === 'finished'){
    logEvent({event:'finished', run: msg.run_id});
    if(activeRuns[msg.run_id]) activeRuns[msg.run_id].finished = true;
    renderRuns();
  } else if(type === 'stopped_all'){
    logEvent({event:'stopped_all', runs: msg.runs || []});
    activeRuns = {};
    renderRuns();
  } else {
    logEvent(msg);
  }
}

/* ========== Files UI ========== */
function renderFiles(){
  const container = document.getElementById('files');
  const q = document.getElementById('q').value.trim().toLowerCase();
  const sort = document.getElementById('sort').value;
  container.innerHTML = '';
  let list = Array.from(filesIndex.values());
  if(q){
    list = list.filter(it => (it.name && it.name.toLowerCase().includes(q)) || (it.url && it.url.toLowerCase().includes(q)) || (it.title && it.title.toLowerCase().includes(q)));
  }
  if(sort === 'new') list.sort((a,b)=> b.ts - a.ts); else list.sort((a,b)=> a.ts - b.ts);

  // build fragment for efficient DOM update
  const frag = document.createDocumentFragment();
  for(const it of list){
    const div = document.createElement('div'); div.className = 'file-item';
    const meta = document.createElement('div'); meta.className = 'file-meta';
    const actions = document.createElement('div'); actions.className = 'file-actions';
    meta.innerHTML = `<div class="fname">${escapeHtml(it.name)}</div>
                      <div class="ftitle">${escapeHtml(it.title || '')}</div>
                      <div class="small muted">Source: <a href="${escapeHtml(it.url||'#')}" target="_blank">${escapeHtml(it.url||'')}</a></div>
                      <div class="small muted">Branch: ${escapeHtml(it.branch || '')}</div>`;
    if(it.content_preview){
      const pre = document.createElement('pre');
      pre.className = 'preview';
      pre.innerText = it.content_preview;
      meta.appendChild(pre);
    }
    const a = document.createElement('a'); a.href = `${API}/output/${encodeName(it.name)}`; a.target='_blank'; a.innerText='Download'; a.className='ghost';
    const btnCopy = document.createElement('button'); btnCopy.innerText='Copy'; btnCopy.className='ghost';
    btnCopy.onclick = ()=>{ navigator.clipboard.writeText(it.content_preview || '').then(()=> toast('Copied')); };

    const btnShowLog = document.createElement('button'); btnShowLog.innerText='Log'; btnShowLog.className='ghost';
    btnShowLog.onclick = ()=> fetchLogForFile(it.name);

    // Open (lazy load full content)
    const btnOpen = document.createElement('button'); btnOpen.innerText='Open'; btnOpen.className='ghost';
    btnOpen.onclick = async ()=> {
      await openFullContentModal(it.name, it);
    };

    actions.appendChild(a); actions.appendChild(btnOpen); actions.appendChild(btnCopy); actions.appendChild(btnShowLog);
    div.appendChild(meta); div.appendChild(actions);
    frag.appendChild(div);
  }
  container.appendChild(frag);
}

/* Lazy fetch + preview modal */
async function openFullContentModal(name, it){
  const previewModal = document.getElementById('previewModal');
  const previewBody = document.getElementById('previewBody');
  const previewTitle = document.getElementById('previewTitle');
  const previewDownload = document.getElementById('previewDownload');

  previewTitle.innerText = name;
  previewBody.innerText = 'Loading...';
  previewModal.style.display = 'block';
  document.getElementById('appRoot').setAttribute('aria-hidden', 'true');

  // If server supports /output/:name returning full text, we fetch it.
  try {
    const res = await fetch(`${API}/output/${encodeName(name)}`, { headers: defaultHeaders() });
    if(!res.ok){
      const txt = await res.text().catch(()=>null);
      previewBody.innerText = `Failed to load: ${res.status} ${txt || ''}`;
      return;
    }
    const text = await res.text();
    previewBody.innerText = text.slice(0, MAX_CONTENT_LEN);
    previewDownload.onclick = ()=> { window.open(`${API}/output/${encodeName(name)}`, '_blank'); };
  } catch(e){
    console.warn('openFullContentModal error', e);
    previewBody.innerText = 'Ошибка загрузки контента';
  }
}

/* ========== Directories (branches) UI ========== */
async function loadDirs(){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  try{
    const res = await fetch(`${API}/dirs`, { headers: defaultHeaders() });
    if(!res.ok) throw new Error('dirs failed');
    const data = await res.json();
    dirs = data.dirs || [];
    renderDirs();
  }catch(e){
    console.warn('loadDirs', e);
    document.getElementById('dirs').innerHTML = '<div class="small muted">Ошибка загрузки веток</div>';
  }
}

function renderDirs(){
  const el = document.getElementById('dirs');
  el.innerHTML = '';
  if(!dirs || dirs.length === 0){
    el.innerHTML = '<div class="small muted">Нет веток</div>';
    return;
  }
  const frag = document.createDocumentFragment();
  dirs.forEach(d=>{
    const div = document.createElement('div'); div.className='dir-item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${escapeHtml(d.branch)}</div><div class="dir-meta">${d.files} file(s) • ${Math.round((d.size||0)/1024)} KB</div>`;
    const right = document.createElement('div');
    const btnDownload = document.createElement('button'); btnDownload.className='ghost'; btnDownload.innerText='Download zip';
    btnDownload.onclick = ()=> { window.open(`${API}/download_dir/${encodeName(d.branch)}`, '_blank'); };
    const btnSelect = document.createElement('button'); btnSelect.className='ghost'; btnSelect.innerText='Select';
    btnSelect.onclick = ()=> { selectBranch(d.branch); };
    right.appendChild(btnSelect); right.appendChild(btnDownload);
    div.appendChild(left); div.appendChild(right);
    frag.appendChild(div);
  });
  el.appendChild(frag);
}

function selectBranch(branch){
  selectedBranch = branch;
  document.getElementById('btnDownloadSelected').disabled = false;
  document.getElementById('btnDownloadSelected').onclick = ()=> { window.open(`${API}/download_dir/${encodeName(branch)}`, '_blank'); };
  toast('Selected: ' + branch, 1500);
}

/* ========== Runs UI ========== */
function renderRuns(){
  const el = document.getElementById('runs');
  el.innerHTML = '';
  const keys = Object.keys(activeRuns).reverse();
  if(keys.length === 0) el.innerHTML = '<div class="small muted">Нет активных запусков</div>';
  const frag = document.createDocumentFragment();
  keys.forEach(id=>{
    const r = activeRuns[id];
    const div = document.createElement('div'); div.className='run-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escapeHtml(id)}</div><div class="small muted">${escapeHtml(r.start_url||'')}</div>`;
    const right = document.createElement('div');
    const btnStop = document.createElement('button'); btnStop.innerText='Stop'; btnStop.onclick = ()=> stopRun(id);
    const btnLogs = document.createElement('button'); btnLogs.className='ghost'; btnLogs.innerText='Logs'; btnLogs.onclick = ()=> downloadRunLog(id);
    right.appendChild(btnLogs); right.appendChild(btnStop);
    div.appendChild(left); div.appendChild(right);
    frag.appendChild(div);
  });
  el.appendChild(frag);
}

/* ========== API actions ========== */
async function startCrawl(bg=false){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  const start_url = document.getElementById('start_url').value.trim();
  if(!start_url) return alert('Укажи start_url');
  const prefix = document.getElementById('prefix').value || null;
  const concurrency = parseInt(document.getElementById('concurrency').value||'5',10);
  const save_html = document.getElementById('save_html').checked;
  const body = { start_url, prefix, concurrency, save_html, bg };
  try{
    const res = await fetch(`${API}/start`, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, defaultHeaders()), body: JSON.stringify(body) });
    if(!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || 'start failed');
    }
    const data = await res.json();
    document.getElementById('start_result').innerText = JSON.stringify(data, null, 2);
    if(data.run_id){
      activeRuns[data.run_id] = { start_url, ts: Date.now() };
      renderRuns();
      toast('Run started: ' + data.run_id);
      document.getElementById('last_run_info').innerText = data.run_id;
    }
  }catch(e){ console.error(e); toast('Start failed'); }
}

async function stopRun(run_id){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  if(!confirm('Остановить run ' + run_id + '?')) return;
  try{
    const res = await fetch(`${API}/stop/${encodeURIComponent(run_id)}`, { method:'POST', headers: defaultHeaders() });
    if(res.ok){
      toast('Stopping ' + run_id);
      delete activeRuns[run_id];
      renderRuns();
    } else {
      toast('Stop failed');
    }
  } catch(e){ toast('Stop error'); }
}

async function stopAll(){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  if(!confirm('Stop all runs?')) return;
  try {
    const res = await fetch(`${API}/stop_all`, { method: 'POST', headers: defaultHeaders() });
    if(res.ok){
      toast('Stopped all runs');
      activeRuns = {};
      renderRuns();
    } else {
      toast('Stop all failed');
    }
  } catch(e){
    console.error('stopAll', e);
    toast('Stop all error');
  }
}

async function fetchLogForFile(fname){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  toast('Fetching log...');
  try{
    const res = await fetch(`${API}/list`, { headers: defaultHeaders() });
    const data = await res.json();
    const logs = (data.files || []).filter(f => f.name.endsWith('.log'));
    if(logs.length === 0){ toast('No logs found'); return; }
    const latest = logs[logs.length-1].name;
    const run_id = latest.replace('.log','');
    downloadRunLog(run_id);
  }catch(e){ console.warn(e); toast('Log fetch failed'); }
}

function downloadRunLog(run_id){
  const url = `${API}/logs/${encodeName(run_id)}`;
  window.open(url, '_blank');
}

/* ========== Login logic (adapted) ========== */
function showLoginModal(open = true){
  document.getElementById('loginModalWrap').style.display = open ? 'block' : 'none';
  if(open){
    document.getElementById('loginInput').focus();
    document.getElementById('appRoot').setAttribute('aria-hidden', 'true');
  } else {
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginInput').value = '';
    document.getElementById('passwordInput').value = '';
    document.getElementById('appRoot').setAttribute('aria-hidden', 'false');
  }
}

async function handleLogin(){
  const login = document.getElementById('loginInput').value || '';
  const password = document.getElementById('passwordInput').value || '';
  const errEl = document.getElementById('loginError');
  if(!login.trim() || !password.trim()){
    errEl.innerText = 'Пожалуйста, введите логин и пароль';
    errEl.style.display = 'block';
    setTimeout(()=> { errEl.style.display = 'none'; }, 5000);
    return;
  }
  const submitBtn = document.getElementById('loginSubmit');
  submitBtn.disabled = true;
  submitBtn.innerText = 'Вхожу...';
  try {
    const response = await fetch(`${API_BASE_URL}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login: login.trim(), password: password.trim() })
    });
    if(!response.ok){
      const text = await response.text().catch(()=>null);
      throw { network: true, status: response.status, text };
    }
    const data = await response.json();
    if (data.status === 'success') {
      const newUser = {
        role: data.role || null,
        id: data.id || null,
        name: data.name || login.trim(),
        telegram_id: data.telegram_id || null,
        apiKey: data.apiKey || data.api_key || null
      };
      if(!newUser.apiKey){
        throw new Error('API key not returned by auth server');
      }
      saveUser(newUser);
      showLoginModal(false);
      toast('Logged in successfully', 2500);
      // after login, init WS and load files/dirs
      initWS();
      await refreshFiles();
      await loadDirs();
    } else {
      errEl.innerText = 'Неправильный логин или пароль';
      errEl.style.display = 'block';
      setTimeout(()=> { errEl.style.display = 'none'; }, 5000);
    }
  } catch (err) {
    console.error('Login error:', err);
    const errElText = (err && err.text) ? (err.text || 'Ошибка сети') : (err?.message || 'Ошибка сети');
    document.getElementById('loginError').innerText = errElText;
    document.getElementById('loginError').style.display = 'block';
    setTimeout(()=> { document.getElementById('loginError').style.display = 'none'; }, 5000);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Войти';
  }
}

function handleLogout(){
  if(!confirm('Выйти?')) return;
  stopWS();
  saveUser(null);
  filesIndex.clear();
  filesOrder=[];
  renderFiles();
  activeRuns = {};
  renderRuns();
  dirs = [];
  renderDirs();
  toast('Logged out', 1500);
  setTimeout(()=> showLoginModal(true), 200);
}

/* ========== UI wiring ========== */
document.getElementById('btnStart').onclick = ()=> startCrawl(false);
document.getElementById('btnStartBG').onclick = ()=> startCrawl(true);
document.getElementById('btnList').onclick = ()=> refreshFiles();
document.getElementById('btnRefresh').onclick = ()=> { if(!user){ showLoginModal(true); toast('Вход обязателен'); return; } refreshFiles(); loadDirs(); toast('Refreshed'); };
document.getElementById('clearSearch').onclick = ()=> { document.getElementById('q').value=''; renderFiles(); };
document.getElementById('q').oninput = debounce(()=> renderFiles(), 200);
document.getElementById('sort').onchange = ()=> renderFiles();
document.getElementById('btnClearLog').onclick = ()=> { document.getElementById('log').innerText=''; };
document.getElementById('btnDownloadLog').onclick = async ()=> {
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  try{
    const res = await fetch(`${API}/list`, { headers: defaultHeaders() });
    const data = await res.json();
    const logs = (data.files||[]).filter(f=>f.name.endsWith('.log'));
    if(logs.length===0){ toast('No logs'); return; }
    const latest = logs[logs.length-1].name.replace('.log','');
    downloadRunLog(latest);
  }catch(e){ toast('err'); }
};
document.getElementById('btnShowFiles').onclick = ()=> {
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  refreshFiles();
};
document.getElementById('btnClearOutputs').onclick = ()=> { filesIndex.clear(); filesOrder=[]; renderFiles(); toast('Cleared local list'); };
document.getElementById('btnStopAll').onclick = ()=> { if(!user){ showLoginModal(true); toast('Вход обязателен'); return; } stopAll(); };
document.getElementById('toggleTheme').onclick = ()=> {
  if(document.documentElement.classList.contains('light')){ document.documentElement.classList.remove('light'); localStorage.setItem('theme','dark'); } else { document.documentElement.classList.add('light'); localStorage.setItem('theme','light'); }
};
document.getElementById('btnRefreshDirs').onclick = ()=> loadDirs();
document.getElementById('btnDownloadSelected').onclick = ()=> { if(selectedBranch) window.open(`${API}/download_dir/${encodeName(selectedBranch)}`, '_blank'); };

/* Login buttons */
document.getElementById('btnLogin').onclick = ()=> showLoginModal(true);
document.getElementById('loginCancel').onclick = ()=> showLoginModal(false);
document.getElementById('loginSubmit').onclick = ()=> handleLogin();
document.getElementById('btnLogout').onclick = ()=> handleLogout();

/* Preview modal buttons */
document.getElementById('previewClose').onclick = ()=> {
  document.getElementById('previewModal').style.display='none';
  document.getElementById('appRoot').setAttribute('aria-hidden','false');
};

/* close modal on backdrop click */
document.getElementById('loginBackdrop').onclick = (e)=> {
  if(e.target === document.getElementById('loginBackdrop')) {
    if(user) showLoginModal(false);
  }
};

/* ========== Utilities ========== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ========== Files list refresh ========== */
async function refreshFiles(){
  if(!user){ showLoginModal(true); toast('Вход обязателен'); return; }
  try{
    const res = await fetch(`${API}/list`, { headers: defaultHeaders() });
    if(!res.ok) throw new Error('list failed');
    const data = await res.json();
    (data.files || []).forEach(f=>{
      if(!filesIndex.has(f.name)){
        filesIndex.set(f.name, { name: f.name, title:'', url:'', content_preview: (f.preview || '').slice(0, PREVIEW_LEN), size: f.size || 0, ts: Date.now(), branch: f.name.includes('/') ? f.name.split('/').slice(0,-1).join('/') : '' });
      }
    });
    filesOrder = Array.from(filesIndex.keys()).sort((a,b)=> filesIndex.get(b).ts - filesIndex.get(a).ts);
    renderFiles();
  }catch(e){
    console.warn('refreshFiles', e);
    toast('Не удалось загрузить список файлов');
  }
}

/* ========== Init: require login on load ========== */
loadUser();
if(user && user.apiKey){
  initWS();
  refreshFiles();
  loadDirs();
} else {
  showLoginModal(true);
  updateUserUI();
}
</script>

</body>
</html>