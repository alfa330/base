<!-- static/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Async Crawler UI</title>
  <style>
    body { font-family: Inter, Arial; max-width:900px; margin:20px auto; padding:10px;}
    input, button { padding:8px; margin:4px 0;}
    .row { display:flex; gap:8px; align-items:center;}
    .card { border:1px solid #e3e3e3; padding:12px; border-radius:8px; margin:8px 0; }
    pre { background:#f6f6f6; padding:8px; overflow:auto;}
  </style>
</head>
<body>
  <h2>Async Crawler — UI</h2>

  <div class="card">
    <div><b>Start URL</b></div>
    <input id="start_url" type="text" placeholder="https://example.com/path" style="width:100%"/>
    <div class="row">
      <input id="prefix" type="text" placeholder="Optional path prefix (e.g. /docs)" />
      <input id="concurrency" type="number" placeholder="concurrency" value="5" style="width:90px" />
      <label><input id="save_html" type="checkbox" /> save html</label>
    </div>
    <div class="row">
      <button id="btnStart">Start</button>
      <button id="btnList">List outputs</button>
    </div>
    <div id="start_result"></div>
  </div>

  <div class="card">
    <div><b>Active runs</b></div>
    <div id="runs"></div>
  </div>

  <div class="card">
    <div><b>Outputs</b></div>
    <div id="files"></div>
  </div>

  <div class="card">
    <div><b>Logs / Last events</b></div>
    <pre id="log" style="height:220px"></pre>
  </div>

<script>
const api = (path, opts) => fetch('/api' + path, opts);

// WebSocket
let ws;
function initWS(){
  ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");
  ws.onopen = () => {
    console.log("WS connected");
    // send occasional ping to keep alive
    setInterval(()=> {
      try { ws.send("ping"); } catch(e) {}
    }, 20000);
  };
  ws.onmessage = (ev) => {
    try {
      // backend sometimes sends plain text ack; handle only JSON
      let msg;
      try { msg = JSON.parse(ev.data); } catch(e) { /* not JSON */ return; }
      handleWsMessage(msg);
    } catch (e) { console.error("ws parse error", e); }
  };
  ws.onclose = () => {
    console.log("WS closed — reconnect in 3s");
    setTimeout(initWS, 3000);
  };
  ws.onerror = (e) => console.warn("WS error", e);
}

function handleWsMessage(msg){
  // example msg: {"run_id":"...", "type":"saved", "index":1, "url":"...", "file":"00001_page_abc.json", "title":"...","content":"..."}
  const t = msg.type || "event";
  if (t === "saved") {
    addFileToUI(msg);
  } else if (t === "run_started") {
    const el = document.getElementById('start_result');
    el.innerText = `Run started: ${msg.run_id} ${msg.start_url || ""}`;
  } else if (t === "finished") {
    // optional handling
    console.log("run finished", msg);
  } else {
    // generic push: show in logs
    const pre = document.getElementById('log');
    pre.innerText += JSON.stringify(msg, null, 2) + "\n";
  }
}

// append file info to UI
function addFileToUI(item){
  const filesEl = document.getElementById('files');
  const name = item.file || item.name || ("item_" + Date.now());
  const div = document.createElement('div');
  div.style.margin = '8px 0';
  const kb = item.size ? Math.round(item.size/1024) + 'KB' : '';
  let contentPreview = "";
  if (item.content) {
    contentPreview = `<pre style="max-height:180px;overflow:auto;margin-top:6px;">${escapeHtml(item.content)}</pre>`;
  }
  div.innerHTML = `<strong>${escapeHtml(name)}</strong> ${kb} — <a href="/api/output/${encodeURIComponent(name)}" target="_blank">Download</a>
    <div>Source: <a href="${escapeHtml(item.url||'#')}" target="_blank">${escapeHtml(item.url||'')}</a></div>
    ${contentPreview}
  `;
  filesEl.prepend(div);
  // also update logs area
  const pre = document.getElementById('log');
  pre.innerText = `Saved: ${name}\n` + (pre.innerText || "");
}

function escapeHtml(s){
  if (!s) return "";
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

// wire start button (keeps previous behavior)
document.getElementById('btnStart').onclick = async () => {
  const start_url = document.getElementById('start_url').value.trim();
  if (!start_url) return alert('Укажи start_url');
  const prefix = document.getElementById('prefix').value || null;
  const concurrency = parseInt(document.getElementById('concurrency').value || '5', 10);
  const save_html = document.getElementById('save_html').checked;
  const body = { start_url, prefix, concurrency, save_html };
  const res = await api('/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const data = await res.json();
  document.getElementById('start_result').innerText = JSON.stringify(data, null, 2);
};

// init
initWS();
</script>
</body>
</html>
